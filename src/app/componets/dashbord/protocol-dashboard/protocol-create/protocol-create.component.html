<div class="protocol-create">
  <app-task-dashboard-page-header
    title="Create Protocol"
    subtitle="Define a new protocol with specific criteria and responsibilities"
    title2="Protocol Type"
    subtitle2="{{ protocolForm.get('protocolType')?.value }}"
  ></app-task-dashboard-page-header>

  <div class="card">
    <div class="card-body">
      <form [formGroup]="protocolForm" (ngSubmit)="submit()">
        <!-- Basic Information Section -->
        <div class="form-section">
          <h5 class="section-title">Basic Information</h5>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Protocol Name <span class="text-danger">*</span></label>
                <input
                  type="text"
                  formControlName="name"
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('name')"
                  placeholder="Enter protocol name"
                />
                <div class="invalid-feedback" *ngIf="isFieldInvalid('name')">
                  {{ getErrorMessage('name') }}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Protocol Type <span class="text-danger">*</span></label>
                <select
                  formControlName="protocolType"
                  class="form-select"
                  [class.is-invalid]="isFieldInvalid('protocolType')"
                >
                  <option *ngFor="let type of protocolTypes" [value]="type">{{ type }}</option>
                </select>
                <div class="invalid-feedback" *ngIf="isFieldInvalid('protocolType')">
                  {{ getErrorMessage('protocolType') }}
                </div>
              </div>
            </div>
          </div>
          <div class="form-group mt-3">
            <label class="form-label">Description <span class="text-danger">*</span></label>
            <textarea
              formControlName="description"
              class="form-control"
              rows="3"
              [class.is-invalid]="isFieldInvalid('description')"
              placeholder="Enter protocol description"
            ></textarea>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('description')">
              {{ getErrorMessage('description') }}
            </div>
          </div>
        </div>

        <!-- Specific Criteria Section -->
        <div class="form-section mt-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title mb-0">Specific Criteria</h5>
            <button
              type="button"
              class="btn btn-outline-primary btn-sm"
              (click)="addCriteria()"
              [disabled]="loading"
            >
              <i class="fe fe-plus me-1"></i>Add Criteria
            </button>
          </div>

          <div formArrayName="specificCriteria">
            <div
              *ngFor="let group of specificCriteria.controls; let i = index"
              [formGroupName]="i"
              class="criteria-card"
            >
              <div class="criteria-header">
                <h6 class="mb-0">Criteria #{{ i + 1 }}</h6>
                <button
                  type="button"
                  class="btn btn-icon btn-danger"
                  (click)="removeCriteria(i)"
                  *ngIf="specificCriteria.length > 1"
                  ngbTooltip="Remove criteria"
                >
                  <i class="fe fe-trash-2"></i>
                </button>
              </div>

              <div class="criteria-body">
                <div class="form-group">
                  <label class="form-label">Description <span class="text-danger">*</span></label>
                  <textarea
                    formControlName="description"
                    class="form-control"
                    rows="2"
                    [class.is-invalid]="isFieldInvalid('description', i)"
                    placeholder="Enter criteria description"
                  ></textarea>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('description', i)">
                    {{ getErrorMessage('description', i) }}
                  </div>
                </div>

                <div class="row mt-3">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Implementation Responsibles <span class="text-danger">*</span></label>
                      <select
                        class="form-select"
                        multiple
                        formControlName="implementationResponsibles"
                        [class.is-invalid]="isFieldInvalid('implementationResponsibles', i)"
                      >
                        <option *ngFor="let dept of departments" [value]="dept.id">
                          {{ dept.name }}
                        </option>
                      </select>
                      <div class="invalid-feedback" *ngIf="isFieldInvalid('implementationResponsibles', i)">
                        {{ getErrorMessage('implementationResponsibles', i) }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Check Responsibles <span class="text-danger">*</span></label>
                      <select
                        class="form-select"
                        multiple
                        formControlName="checkResponsibles"
                        [class.is-invalid]="isFieldInvalid('checkResponsibles', i)"
                      >
                        <option *ngFor="let dept of departments" [value]="dept.id">
                          {{ dept.name }}
                        </option>
                      </select>
                      <div class="invalid-feedback" *ngIf="isFieldInvalid('checkResponsibles', i)">
                        {{ getErrorMessage('checkResponsibles', i) }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions mt-4">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="protocolForm.invalid || submitting || loading"
          >
            <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2" role="status"></span>
            {{ submitting ? 'Creating...' : 'Create Protocol' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>